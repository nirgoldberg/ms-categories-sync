/*! ms-tax-sync 2020-01-02 */

var $=jQuery,mstaxsync=function(){function r(t){return $("."+t+"-list")}var t={},d={relationship_fields:$(".mstaxsync-relationship"),single_post_meta_box:$("#mstaxsync_single_post_broadcast"),rtl:$("html").attr("dir")&&"rtl"==$("html").attr("dir")},s=function(t){var n=_mstaxsync.settings.edit_terms,e=[];return t.children&&t.children.length&&($.each(t.children,function(t,n){e.push(s({id:n.id,text:n.text,children:n.children}))}),e=e.join("")),['<li class="new">',"<div>",'<span class="mstaxsync-rel-item" data-id="'+t.id+'">','<span class="val">'+t.text+"</span>",n?'<input type="text" placeholder="'+t.text+'" />':"",'<span class="ind">('+_mstaxsync.strings.relationship_new_item_str+")</span>",n?'<span class="edit dashicons dashicons-edit"></span><span class="ok dashicons dashicons-yes"></span><span class="cancel dashicons dashicons-no"></span>':"",'<span class="remove dashicons dashicons-minus"></span>',"</span>","</div>",e.length?"<ul>"+e+"</ul>":"","</li>"].join("")};t.init=function(){n(),S(),L()};var n=function(){d.relationship_fields.length&&(_mstaxsync.settings.advanced_treeview.length?e():i(),c(),$('#mstaxsync-taxonomies input[name="submit"]').click(function(t){t.preventDefault(),A($(this))}),Q())},e=function(){a(),$("body").on("click",".choices-list li .mstaxsync-rel-item",function(){l($(this))}),$("body").on("click",'.choices-list li .mstaxsync-rel-item input[type="checkbox"]',function(t){t.stopPropagation(),m($(this).closest(d.relationship_fields))}),$("body").on("click",".choices-list li .mstaxsync-rel-item .check-all",function(t){t.stopPropagation(),o($(this))}),$("body").on("click",".choices-list li .mstaxsync-rel-item .uncheck-all",function(t){t.stopPropagation(),h($(this))}),$("body").on("click",".advanced-treeview-controls .check-all",function(t){u($(this))}),$("body").on("click",".advanced-treeview-controls .uncheck-all",function(t){p($(this))}),$("body").on("click",".advanced-treeview-controls .add-items",function(){f($(this))})},i=function(){$("body").on("click",".choices-list li .mstaxsync-rel-item",function(){b($(this))})},c=function(){$("body").on("click",".values-list li .remove",function(){k($(this).parent(".mstaxsync-rel-item"))}),$("body").on("click",".values-list li .edit",function(){C($(this))}),$("body").on("click",".values-list li .ok",function(){j($(this))}),$("body").on("keypress",".values-list li input",function(t){w(t)}),$("body").on("click",".values-list li .cancel",function(){T($(this))}),$("body").on("click",".values-list li .synced",function(){P($(this))}),$("body").on("click",".values-list li .trash",function(){E($(this))})},a=function(){var t=$('.mstaxsync-rel-item.disabled input[type="checkbox"]');t.length&&t.prop({checked:!0,disabled:!0})},l=function(t){var n=t.closest(d.relationship_fields),e=t.children('input[type="checkbox"]');if(t.hasClass("disabled"))return!1;e.prop("checked",!e.prop("checked")),m(n)},o=function(t){var n=t.closest(d.relationship_fields);t.closest("li").find('input[type="checkbox"]').prop("checked",!0),m(n)},h=function(t){var n=t.closest(d.relationship_fields);t.closest("li").find('input[type="checkbox"]').each(function(){var t=$(this);t.parent(".mstaxsync-rel-item").hasClass("disabled")||t.prop("checked",!1)}),m(n)},u=function(t){var n=t.closest(".mstaxsync-taxonomy-terms-box").children(d.relationship_fields),e=n.find(r("choices")).find('input[type="checkbox"]');e.length&&e.prop("checked",!0),m(n)},p=function(t){var n=t.closest(".mstaxsync-taxonomy-terms-box").children(d.relationship_fields),e=n.find(r("choices")).find('input[type="checkbox"]');e.length&&(e.each(function(){var t=$(this);t.parent(".mstaxsync-rel-item").hasClass("disabled")||t.prop("checked",!1)}),m(n))},m=function(t){var n=t.find(r("choices")).find('input[type="checkbox"]'),e=t.next(".advanced-treeview-controls").children(".add-items"),i=!1;n.length&&n.each(function(){var t=$(this);if(!t.parent(".mstaxsync-rel-item").hasClass("disabled")&&t.prop("checked"))return!(i=!0)}),i?e.addClass("enabled"):e.removeClass("enabled")},f=function(t){if(t.hasClass("enabled")){var n=t.closest(".mstaxsync-taxonomy-terms-box").children(d.relationship_fields),e=n.find(r("choices")).children("li"),i=[],s=[];e.length&&e.each(function(){y(i,s,$(this),0)}),_(n,s)}},y=function(t,n,e,i){var s=e.find(".mstaxsync-rel-item").first(),c=s.data("id"),a=s.children('input[type="checkbox"]'),l=s.children(".val").text(),o=e.children("ul").children("li"),r=x(t,i),d=!s.hasClass("disabled")&&a.prop("checked");t.push({id:c,parent:i,valid:d}),d&&n.push({id:c,text:l,parent:r}),o.length&&(i=c,o.each(function(){y(t,n,$(this),i)}))},x=function(t,n){if(0==n)return 0;var e=$.grep(t,function(t){return t.id==n});if(e.length){var i=e[0].parent;return e[0].valid?n:x(t,i)}return 0},_=function(t,n){var c=t.find(r("choices")),e=t.next(".advanced-treeview-controls").children(".add-items"),a=[];e.removeClass("enabled"),n.length&&($.each(n,function(t,n){var e=n.id,i=c.find("li .mstaxsync-rel-item[data-id="+e+"]"),s=i.children('input[type="checkbox"]');i.addClass("disabled"),s.prop({disabled:!0}),v(a,n)}),g(t,a))},v=function(t,e){var i=e.id,s=e.text,c=e.parent;0==c?t.push({id:i,text:s,children:[]}):$.each(t,function(t,n){if(c==n.id)return n.children.push({id:i,text:s,children:[]}),!1;n.children&&n.children.length&&v(n.children,e)})},g=function(i,t){t.length&&$.each(t,function(t,n){var e=s({id:n.id,text:n.text,children:n.children});i.find(r("values")).append(e)})},b=function(t){var n=t.closest(d.relationship_fields);if(t.hasClass("disabled"))return!1;t.addClass("disabled");var e=s({id:t.data("id"),text:t.children(".val").text()});n.find(r("values")).append(e)},k=function(t){var n=t.closest(d.relationship_fields),e=t.data("id"),i=t.closest("li"),s=i.children("ul"),c=i.siblings(),a=n.find(r("choices")).find("li .mstaxsync-rel-item[data-id="+e+"]"),l=_mstaxsync.settings.advanced_treeview;c.length||i.parent("ul").hasClass("list")||s.length||i.unwrap("ul"),s.length?(i.children("div").remove(),s.children("li").unwrap("ul").unwrap("li")):i.remove(),a.removeClass("disabled"),l.length&&a.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})},C=function(t){var n=t.closest(".mstaxsync-rel-item"),e=n.children("input");n.addClass("editing"),e.focus()},j=function(t){var n=t.closest(".mstaxsync-rel-item"),e=n.children(".val"),i=n.children("input");i.val().length&&(e.text(i.val()),i.attr("placeholder",e.text()),i.val(""),O(n.closest("li"))),n.removeClass("editing")},w=function(t){"13"==(t.keyCode?t.keyCode:t.which)&&j($(t.target)),t.stopPropagation()},T=function(t){var n=t.closest(".mstaxsync-rel-item");n.children("input").val(""),n.removeClass("editing")},P=function(i){var t=i.closest(d.relationship_fields),n=i.data("nonce"),e=i.closest(".mstaxsync-rel-item"),s=e.data("id"),c=e.data("synced"),a=t.find(r("choices")).find("li .mstaxsync-rel-item[data-id="+c+"]"),l=_mstaxsync.settings.advanced_treeview;_mstaxsync.settings.detach_terms&&confirm(_mstaxsync.strings.confirm_detach)&&(i.addClass("rotate"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"detach_taxonomy_term",nonce:n,main_id:c,local_id:s},success:function(t){i.remove(),e.data("synced",""),a.removeClass("disabled"),a.data("synced",""),l.length&&a.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})},error:function(t,n,e){i.removeClass("rotate")}}))},E=function(t){var n=t.closest(d.relationship_fields),e=t.data("nonce"),i=t.closest(".mstaxsync-rel-item"),s=n.data("name"),c=i.data("id"),a=i.data("synced"),l=_mstaxsync.settings.advanced_treeview,o=_mstaxsync.settings.delete_terms;i.children(".synced");o&&confirm(_mstaxsync.strings.confirm_delete)&&(i.addClass("removing"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"delete_taxonomy_term",nonce:e,taxonomy:s,main_id:a,local_id:c},success:function(t){a&&(choice=n.find(r("choices")).find("li .mstaxsync-rel-item[data-id="+a+"]"),choice.removeClass("disabled"),choice.data("synced",""),l.length&&choice.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})),i.css("opacity","0"),setTimeout(function(){k(i)},500)},error:function(t,n,e){i.removeClass("removing")}}))},A=function(t){var n=t.data("nonce"),e=I(),i=$(".submit .ajax-loading"),s=$(".submit").next(".result"),c=[];i.css("visibility","visible"),s.html("").hide(),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"taxonomy_terms_sync",nonce:n,taxonomy_terms:e},success:function(t){B(t),D(t,c)},error:function(t,n,e){c.push(_mstaxsync.strings.relationship_internal_server_error_str)},complete:function(t,n){i.css("visibility","hidden"),s.show().html(c.join("<br />"))}})},I=function(){return taxonomyTerms=[],$.each(d.relationship_fields,function(){var t=$(this).find(r("values")).children("li"),n=[];t.length&&(t.each(function(){q(n,$(this),0)}),taxonomyTerms.push({taxonomy:$(this).data("name"),terms:n}))}),taxonomyTerms},q=function(t,n,e){var i=n.find(".mstaxsync-rel-item").first(),s=i.data("id"),c=i.children(".val").text(),a=n.hasClass("new")?"main":"local",l=n.children("ul").children("li");t.push({id:s,name:c,source:a,parent:e}),l.length&&(e=s,l.each(function(){q(t,$(this),e)}))},B=function(t){var c=_mstaxsync.settings.advanced_treeview;Object.keys(t.rs_fields).length&&$.each(t.rs_fields,function(t,n){var e=$('.mstaxsync-relationship[data-name="'+t+'"]'),i=n.choices,s=n.values;i.length&&(e.find(r("choices")).html(i),c.length&&a()),s.length&&e.find(r("values")).html(s)})},D=function(t,e){t.errors.length||e.push(_mstaxsync.strings.relationship_success_str),t.main.length&&e.push(t.main.length+" "+_mstaxsync.strings.relationship_main_terms_str),t.local.length&&e.push(t.local.length+" "+_mstaxsync.strings.relationship_local_terms_str),t.errors.length&&(e.push(_mstaxsync.strings.relationship_errors_str),$.each(t.errors,function(t,n){e.push(_mstaxsync.strings.relationship_error_str+" #"+n.code+": "+n.description)}))},O=function(t){var n=t.find(".mstaxsync-rel-item").first(),e=n.children(".val"),i=n.children(".ind"),s=n.children(".edit");t.addClass("changed"),i.length||(i=$('<span class="ind">('+_mstaxsync.strings.relationship_changed_item_str+")</span>"),s.length?i.insertBefore(s):i.insertAfter(e))},Q=function(){r("values").nestedSortable({listType:"ul",items:"li",handle:"div",toleranceElement:"> div",opacity:.6,revert:250,rtl:d.rtl,relocate:function(t,n){O(n.item)}})},S=function(){z(),H(),K()},z=function(){d.single_post_meta_box.length&&(d.single_post_meta_box.find(".check-all").click(function(){F($(this))}),d.single_post_meta_box.find(".uncheck-all").click(function(){G($(this))}))},F=function(t){t.closest(d.single_post_meta_box).find(".synced-sites input.unsynced-post").prop("checked",!0)},G=function(t){t.closest(d.single_post_meta_box).find(".synced-sites input.unsynced-post").prop("checked",!1)},H=function(){if("undefined"!=typeof inlineEditPost){var e=inlineEditPost.edit;inlineEditPost.edit=function(t){e.apply(this,arguments);var n=0;"object"==typeof t&&(n=parseInt(this.getId(t))),0<n&&J(n)}}},J=function(t){var n=$("#edit-"+t),e=$("#post-"+t).find(".column-mstaxsync_synced li"),i=n.find(".mstaxsync-broadcast-checklist li"),s=[];e.length&&i.length&&(e.each(function(){s.push($(this).attr("id"))}),i.each(function(){var t=$(this).attr("id"),n=!1,e=!1;-1<$.inArray(t,s)&&(e=n=!0),$(this).find("input").prop({checked:n,disabled:e})}))},K=function(){$("body").on("click",'input[name="bulk_edit"]',function(){$(this).after('<span class="spinner is-active"></span>');var t=$("#mstaxsync_quick_edit_post_broadcast").val(),n=$("tr#bulk-edit"),e=[],i=n.find(".mstaxsync-broadcast-checklist li"),s=[];n.find("#bulk-titles").children().each(function(){e.push($(this).attr("id").replace(/^(ttle)/i,""))}),e.length&&(i.each(function(){checked=$(this).find("input").attr("checked"),checked&&(id=$(this).attr("id").replace(/^(site-)/i,""),s.push(id))}),$.ajax({type:"post",url:_mstaxsync.ajaxurl,async:!1,cache:!1,data:{action:"bulk_broadcast",nonce:t,post_ids:e,dest_sites:s}}))})},L=function(){$("body").on("click",".mstaxsync-import",function(){M($(this))})},M=function(e){var t=e.data("nonce"),n=e.data("id"),i=e.data("term-count"),s=_mstaxsync.settings.import_posts,c=1<i?_mstaxsync.strings.confirm_import.replace("%s",i):_mstaxsync.strings.confirm_single_import;!e.hasClass("active")&&s&&confirm(c)&&(e.addClass("active"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"import_taxonomy_term_posts",nonce:t,main_term_id:n},success:function(t){},error:function(t,n,e){},complete:function(t,n){e.removeClass("active")}}))};return t}();mstaxsync.init();