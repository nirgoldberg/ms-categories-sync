/*! ms-tax-sync 2019-11-05 */

var $=jQuery,mstaxsync={params:{relationship_fields:$(".mstaxsync-relationship"),rtl:$("html").attr("dir")&&"rtl"==$("html").attr("dir")},$list:function(s){return $("."+s+"-list")},rsGetInputName:function(s){return s.data("name")},rsNewValue:function(s){var e=_mstaxsync.settings.edit_terms,t=[];return s.children&&s.children.length&&($.each(s.children,function(s,e){t.push(mstaxsync.rsNewValue({id:e.id,text:e.text,children:e.children}))}),t=t.join("")),['<li class="new">',"<div>",'<span class="mstaxsync-rel-item" data-id="'+s.id+'">','<span class="val">'+s.text+"</span>",e?'<input type="text" placeholder="'+s.text+'" />':"",'<span class="ind">('+_mstaxsync.strings.relationship_new_item_str+")</span>",e?'<span class="edit dashicons dashicons-edit"></span><span class="ok dashicons dashicons-yes"></span><span class="cancel dashicons dashicons-no"></span>':"",'<span class="remove dashicons dashicons-minus"></span>',"</span>","</div>",t.length?"<ul>"+t+"</ul>":"","</li>"].join("")},init:function(){mstaxsync.relationship()},relationship:function(){mstaxsync.params.relationship_fields.length&&(_mstaxsync.settings.advanced_treeview.length?mstaxsync.relationshipAdvancedTreeview():mstaxsync.relationshipSimpleTreeview(),mstaxsync.relationshipValues(),$('#mstaxsync-taxonomies input[name="submit"]').click(function(s){s.preventDefault(),mstaxsync.rsOnSubmit($(this))}),mstaxsync.relationshipNestedSortable())},relationshipAdvancedTreeview:function(){mstaxsync.rsInitAdvancedTreeview(),$("body").on("click",".choices-list li .mstaxsync-rel-item",function(){mstaxsync.rsOnClickToggle($(this))}),$("body").on("click",'.choices-list li .mstaxsync-rel-item input[type="checkbox"]',function(s){s.stopPropagation(),mstaxsync.rsCheckTreeState($(this).closest(mstaxsync.params.relationship_fields))}),$("body").on("click",".choices-list li .mstaxsync-rel-item .check-all",function(s){s.stopPropagation(),mstaxsync.rsOnClickCheckAllChildren($(this))}),$("body").on("click",".choices-list li .mstaxsync-rel-item .uncheck-all",function(s){s.stopPropagation(),mstaxsync.rsOnClickUncheckAllChildren($(this))}),$("body").on("click",".advanced-treeview-controls .check-all",function(s){mstaxsync.rsOnClickCheckAllTree($(this))}),$("body").on("click",".advanced-treeview-controls .uncheck-all",function(s){mstaxsync.rsOnClickUncheckAllTree($(this))}),$("body").on("click",".advanced-treeview-controls .add-items",function(){mstaxsync.rsOnClickAddItems($(this))})},relationshipSimpleTreeview:function(){$("body").on("click",".choices-list li .mstaxsync-rel-item",function(){mstaxsync.rsOnClickAdd($(this))})},relationshipValues:function(){$("body").on("click",".values-list li .remove",function(){mstaxsync.rsOnClickRemove($(this).parent(".mstaxsync-rel-item"))}),$("body").on("click",".values-list li .edit",function(){mstaxsync.rsOnClickEdit($(this))}),$("body").on("click",".values-list li .ok",function(){mstaxsync.rsOnClickSubmitEdit($(this))}),$("body").on("keypress",".values-list li input",function(s){mstaxsync.rsOnKeypressSubmitEdit(s)}),$("body").on("click",".values-list li .cancel",function(){mstaxsync.rsOnClickCancelEdit($(this))}),$("body").on("click",".values-list li .synced",function(){mstaxsync.rsOnClickDetach($(this))}),$("body").on("click",".values-list li .trash",function(){mstaxsync.rsOnClickDelete($(this))})},rsInitAdvancedTreeview:function(){var s=$('.mstaxsync-rel-item.disabled input[type="checkbox"]');s.length&&s.prop({checked:!0,disabled:!0})},rsOnClickToggle:function(s){var e=s.closest(mstaxsync.params.relationship_fields),t=s.children('input[type="checkbox"]');if(s.hasClass("disabled"))return!1;t.prop("checked",!t.prop("checked")),mstaxsync.rsCheckTreeState(e)},rsOnClickCheckAllChildren:function(s){var e=s.closest(mstaxsync.params.relationship_fields);s.closest("li").find('input[type="checkbox"]').prop("checked",!0),mstaxsync.rsCheckTreeState(e)},rsOnClickUncheckAllChildren:function(s){var e=s.closest(mstaxsync.params.relationship_fields);s.closest("li").find('input[type="checkbox"]').each(function(){var s=$(this);s.parent(".mstaxsync-rel-item").hasClass("disabled")||s.prop("checked",!1)}),mstaxsync.rsCheckTreeState(e)},rsOnClickCheckAllTree:function(s){var e=s.closest(".mstaxsync-taxonomy-terms-box").children(mstaxsync.params.relationship_fields),t=e.find(mstaxsync.$list("choices")).find('input[type="checkbox"]');t.length&&t.prop("checked",!0),mstaxsync.rsCheckTreeState(e)},rsOnClickUncheckAllTree:function(s){var e=s.closest(".mstaxsync-taxonomy-terms-box").children(mstaxsync.params.relationship_fields),t=e.find(mstaxsync.$list("choices")).find('input[type="checkbox"]');t.length&&(t.each(function(){var s=$(this);s.parent(".mstaxsync-rel-item").hasClass("disabled")||s.prop("checked",!1)}),mstaxsync.rsCheckTreeState(e))},rsCheckTreeState:function(s){var e=s.find(mstaxsync.$list("choices")).find('input[type="checkbox"]'),t=s.next(".advanced-treeview-controls").children(".add-items"),n=!1;e.length&&e.each(function(){var s=$(this);if(!s.parent(".mstaxsync-rel-item").hasClass("disabled")&&s.prop("checked"))return!(n=!0)}),n?t.addClass("enabled"):t.removeClass("enabled")},rsOnClickAddItems:function(s){if(s.hasClass("enabled")){var e=s.closest(".mstaxsync-taxonomy-terms-box").children(mstaxsync.params.relationship_fields),t=e.find(mstaxsync.$list("choices")).children("li"),n=[],i=[];t.length&&t.each(function(){mstaxsync.rsBuildValuesItems(n,i,$(this),0)}),mstaxsync.rsAddItems(e,i)}},rsBuildValuesItems:function(s,e,t,n){var i=t.find(".mstaxsync-rel-item").first(),a=i.data("id"),c=i.children('input[type="checkbox"]'),l=i.children(".val").text(),r=t.children("ul").children("li"),d=mstaxsync.rsGetValidParent(s,n),o=!i.hasClass("disabled")&&c.prop("checked");s.push({id:a,parent:n,valid:o}),o&&e.push({id:a,text:l,parent:d}),r.length&&(n=a,r.each(function(){mstaxsync.rsBuildValuesItems(s,e,$(this),n)}))},rsGetValidParent:function(s,e){if(0==e)return 0;var t=$.grep(s,function(s){return s.id==e});if(t.length){var n=t[0].parent;return t[0].valid?e:mstaxsync.rsGetValidParent(s,n)}return 0},rsAddItems:function(s,e){var a=s.find(mstaxsync.$list("choices")),t=s.next(".advanced-treeview-controls").children(".add-items"),c=[];t.removeClass("enabled"),e.length&&($.each(e,function(s,e){var t=e.id,n=a.find("li .mstaxsync-rel-item[data-id="+t+"]"),i=n.children('input[type="checkbox"]');n.addClass("disabled"),i.prop({disabled:!0}),mstaxsync.rsAddItem(c,e)}),mstaxsync.rsAppendItems(s,c))},rsAddItem:function(s,t){var n=t.id,i=t.text,a=t.parent;0==a?s.push({id:n,text:i,children:[]}):$.each(s,function(s,e){if(a==e.id)return e.children.push({id:n,text:i,children:[]}),!1;e.children&&e.children.length&&mstaxsync.rsAddItem(e.children,t)})},rsAppendItems:function(n,s){s.length&&$.each(s,function(s,e){var t=mstaxsync.rsNewValue({id:e.id,text:e.text,children:e.children});n.find(mstaxsync.$list("values")).append(t)})},rsOnClickAdd:function(s){var e=s.closest(mstaxsync.params.relationship_fields);if(s.hasClass("disabled"))return!1;s.addClass("disabled");var t=mstaxsync.rsNewValue({id:s.data("id"),text:s.children(".val").text()});e.find(mstaxsync.$list("values")).append(t)},rsOnClickRemove:function(s){var e=s.closest(mstaxsync.params.relationship_fields),t=s.data("id"),n=s.closest("li"),i=n.children("ul"),a=n.siblings(),c=e.find(mstaxsync.$list("choices")).find("li .mstaxsync-rel-item[data-id="+t+"]"),l=_mstaxsync.settings.advanced_treeview;a.length||n.parent("ul").hasClass("list")||i.length||n.unwrap("ul"),i.length?(n.children("div").remove(),i.children("li").unwrap("ul").unwrap("li")):n.remove(),c.removeClass("disabled"),l.length&&c.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})},rsOnClickEdit:function(s){var e=s.closest(".mstaxsync-rel-item"),t=e.children("input");e.addClass("editing"),t.focus()},rsOnClickSubmitEdit:function(s){var e=s.closest(".mstaxsync-rel-item"),t=e.children(".val"),n=e.children("input");n.val().length&&(t.text(n.val()),n.attr("placeholder",t.text()),n.val(""),mstaxsync.rsIndicateChanged(e.closest("li"))),e.removeClass("editing")},rsOnKeypressSubmitEdit:function(s){"13"==(s.keyCode?s.keyCode:s.which)&&mstaxsync.rsOnClickSubmitEdit($(s.target)),s.stopPropagation()},rsOnClickCancelEdit:function(s){var e=s.closest(".mstaxsync-rel-item");e.children("input").val(""),e.removeClass("editing")},rsOnClickDetach:function(n){var s=n.closest(mstaxsync.params.relationship_fields),e=n.data("nonce"),t=n.closest(".mstaxsync-rel-item"),i=t.data("id"),a=t.data("synced"),c=s.find(mstaxsync.$list("choices")).find("li .mstaxsync-rel-item[data-id="+a+"]"),l=_mstaxsync.settings.advanced_treeview;_mstaxsync.settings.detach_terms&&confirm(_mstaxsync.strings.confirm_detach)&&(n.addClass("rotate"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"detach_taxonomy_term",nonce:e,main_id:a,local_id:i},success:function(s){n.remove(),t.data("synced",""),c.removeClass("disabled"),c.data("synced",""),l.length&&c.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})},error:function(s,e,t){n.removeClass("rotate")}}))},rsOnClickDelete:function(s){var e=s.closest(mstaxsync.params.relationship_fields),t=s.data("nonce"),n=s.closest(".mstaxsync-rel-item"),i=e.data("name"),a=n.data("id"),c=n.data("synced"),l=_mstaxsync.settings.advanced_treeview,r=_mstaxsync.settings.delete_terms;n.children(".synced");r&&confirm(_mstaxsync.strings.confirm_delete)&&(n.addClass("removing"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"delete_taxonomy_term",nonce:t,taxonomy:i,main_id:c,local_id:a},success:function(s){c&&(choice=e.find(mstaxsync.$list("choices")).find("li .mstaxsync-rel-item[data-id="+c+"]"),choice.removeClass("disabled"),choice.data("synced",""),l.length&&choice.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})),n.css("opacity","0"),setTimeout(function(){mstaxsync.rsOnClickRemove(n)},500)},error:function(s,e,t){n.removeClass("removing")}}))},rsOnSubmit:function(s){var e=s.data("nonce"),t=mstaxsync.rsGroupTaxonomyTerms(),n=$(".submit .ajax-loading"),i=$(".submit").next(".result"),a=[];n.css("visibility","visible"),i.html("").hide(),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"taxonomy_terms_sync",nonce:e,taxonomy_terms:t},success:function(s){mstaxsync.rsRefreshLists(s),mstaxsync.rsBuildResultMsg(s,a)},error:function(s,e,t){a.push(_mstaxsync.strings.relationship_internal_server_error_str)},complete:function(s,e){n.css("visibility","hidden"),i.show().html(a.join("<br />"))}})},rsGroupTaxonomyTerms:function(){return taxonomyTerms=[],$.each(mstaxsync.params.relationship_fields,function(){var s=$(this).find(mstaxsync.$list("values")).children("li"),e=[];s.length&&(s.each(function(){mstaxsync.rsBuildTaxonomyTerms(e,$(this),0)}),taxonomyTerms.push({taxonomy:$(this).data("name"),terms:e}))}),taxonomyTerms},rsBuildTaxonomyTerms:function(s,e,t){var n=e.find(".mstaxsync-rel-item").first(),i=n.data("id"),a=n.children(".val").text(),c=e.hasClass("new")?"main":"local",l=e.children("ul").children("li");s.push({id:i,name:a,source:c,parent:t}),l.length&&(t=i,l.each(function(){mstaxsync.rsBuildTaxonomyTerms(s,$(this),t)}))},rsRefreshLists:function(s){var a=_mstaxsync.settings.advanced_treeview;Object.keys(s.rs_fields).length&&$.each(s.rs_fields,function(s,e){var t=$('.mstaxsync-relationship[data-name="'+s+'"]'),n=e.choices,i=e.values;n.length&&(t.find(mstaxsync.$list("choices")).html(n),a.length&&mstaxsync.rsInitAdvancedTreeview()),i.length&&t.find(mstaxsync.$list("values")).html(i)})},rsBuildResultMsg:function(s,t){s.errors.length||t.push(_mstaxsync.strings.relationship_success_str),s.main.length&&t.push(s.main.length+" "+_mstaxsync.strings.relationship_main_terms_str),s.local.length&&t.push(s.local.length+" "+_mstaxsync.strings.relationship_local_terms_str),s.errors.length&&(t.push(_mstaxsync.strings.relationship_errors_str),$.each(s.errors,function(s,e){t.push(_mstaxsync.strings.relationship_error_str+" #"+e.code+": "+e.description)}))},rsIndicateChanged:function(s){var e=s.find(".mstaxsync-rel-item").first(),t=e.children(".val"),n=e.children(".ind"),i=e.children(".edit");s.addClass("changed"),n.length||(n=$('<span class="ind">('+_mstaxsync.strings.relationship_changed_item_str+")</span>"),i.length?n.insertBefore(i):n.insertAfter(t))},relationshipNestedSortable:function(){mstaxsync.$list("values").nestedSortable({listType:"ul",items:"li",handle:"div",toleranceElement:"> div",opacity:.6,revert:250,rtl:mstaxsync.params.rtl,relocate:function(s,e){mstaxsync.rsIndicateChanged(e.item)}})}};$(mstaxsync.init);