/*! ms-tax-sync 2019-12-05 */

var $=jQuery,mstaxsync=function(){function r(e){return $("."+e+"-list")}var e={},d={relationship_fields:$(".mstaxsync-relationship"),single_post_meta_box:$("#mstaxsync_single_post_broadcast"),rtl:$("html").attr("dir")&&"rtl"==$("html").attr("dir")},i=function(e){var t=_mstaxsync.settings.edit_terms,n=[];return e.children&&e.children.length&&($.each(e.children,function(e,t){n.push(i({id:t.id,text:t.text,children:t.children}))}),n=n.join("")),['<li class="new">',"<div>",'<span class="mstaxsync-rel-item" data-id="'+e.id+'">','<span class="val">'+e.text+"</span>",t?'<input type="text" placeholder="'+e.text+'" />':"",'<span class="ind">('+_mstaxsync.strings.relationship_new_item_str+")</span>",t?'<span class="edit dashicons dashicons-edit"></span><span class="ok dashicons dashicons-yes"></span><span class="cancel dashicons dashicons-no"></span>':"",'<span class="remove dashicons dashicons-minus"></span>',"</span>","</div>",n.length?"<ul>"+n+"</ul>":"","</li>"].join("")};e.init=function(){t(),z()};var t=function(){d.relationship_fields.length&&(_mstaxsync.settings.advanced_treeview.length?n():s(),c(),$('#mstaxsync-taxonomies input[name="submit"]').click(function(e){e.preventDefault(),B($(this))}),q())},n=function(){a(),$("body").on("click",".choices-list li .mstaxsync-rel-item",function(){l($(this))}),$("body").on("click",'.choices-list li .mstaxsync-rel-item input[type="checkbox"]',function(e){e.stopPropagation(),m($(this).closest(d.relationship_fields))}),$("body").on("click",".choices-list li .mstaxsync-rel-item .check-all",function(e){e.stopPropagation(),o($(this))}),$("body").on("click",".choices-list li .mstaxsync-rel-item .uncheck-all",function(e){e.stopPropagation(),h($(this))}),$("body").on("click",".advanced-treeview-controls .check-all",function(e){u($(this))}),$("body").on("click",".advanced-treeview-controls .uncheck-all",function(e){p($(this))}),$("body").on("click",".advanced-treeview-controls .add-items",function(){f($(this))})},s=function(){$("body").on("click",".choices-list li .mstaxsync-rel-item",function(){b($(this))})},c=function(){$("body").on("click",".values-list li .remove",function(){k($(this).parent(".mstaxsync-rel-item"))}),$("body").on("click",".values-list li .edit",function(){C($(this))}),$("body").on("click",".values-list li .ok",function(){w($(this))}),$("body").on("keypress",".values-list li input",function(e){j(e)}),$("body").on("click",".values-list li .cancel",function(){T($(this))}),$("body").on("click",".values-list li .synced",function(){P($(this))}),$("body").on("click",".values-list li .trash",function(){A($(this))})},a=function(){var e=$('.mstaxsync-rel-item.disabled input[type="checkbox"]');e.length&&e.prop({checked:!0,disabled:!0})},l=function(e){var t=e.closest(d.relationship_fields),n=e.children('input[type="checkbox"]');if(e.hasClass("disabled"))return!1;n.prop("checked",!n.prop("checked")),m(t)},o=function(e){var t=e.closest(d.relationship_fields);e.closest("li").find('input[type="checkbox"]').prop("checked",!0),m(t)},h=function(e){var t=e.closest(d.relationship_fields);e.closest("li").find('input[type="checkbox"]').each(function(){var e=$(this);e.parent(".mstaxsync-rel-item").hasClass("disabled")||e.prop("checked",!1)}),m(t)},u=function(e){var t=e.closest(".mstaxsync-taxonomy-terms-box").children(d.relationship_fields),n=t.find(r("choices")).find('input[type="checkbox"]');n.length&&n.prop("checked",!0),m(t)},p=function(e){var t=e.closest(".mstaxsync-taxonomy-terms-box").children(d.relationship_fields),n=t.find(r("choices")).find('input[type="checkbox"]');n.length&&(n.each(function(){var e=$(this);e.parent(".mstaxsync-rel-item").hasClass("disabled")||e.prop("checked",!1)}),m(t))},m=function(e){var t=e.find(r("choices")).find('input[type="checkbox"]'),n=e.next(".advanced-treeview-controls").children(".add-items"),s=!1;t.length&&t.each(function(){var e=$(this);if(!e.parent(".mstaxsync-rel-item").hasClass("disabled")&&e.prop("checked"))return!(s=!0)}),s?n.addClass("enabled"):n.removeClass("enabled")},f=function(e){if(e.hasClass("enabled")){var t=e.closest(".mstaxsync-taxonomy-terms-box").children(d.relationship_fields),n=t.find(r("choices")).children("li"),s=[],i=[];n.length&&n.each(function(){y(s,i,$(this),0)}),v(t,i)}},y=function(e,t,n,s){var i=n.find(".mstaxsync-rel-item").first(),c=i.data("id"),a=i.children('input[type="checkbox"]'),l=i.children(".val").text(),o=n.children("ul").children("li"),r=x(e,s),d=!i.hasClass("disabled")&&a.prop("checked");e.push({id:c,parent:s,valid:d}),d&&t.push({id:c,text:l,parent:r}),o.length&&(s=c,o.each(function(){y(e,t,$(this),s)}))},x=function(e,t){if(0==t)return 0;var n=$.grep(e,function(e){return e.id==t});if(n.length){var s=n[0].parent;return n[0].valid?t:x(e,s)}return 0},v=function(e,t){var c=e.find(r("choices")),n=e.next(".advanced-treeview-controls").children(".add-items"),a=[];n.removeClass("enabled"),t.length&&($.each(t,function(e,t){var n=t.id,s=c.find("li .mstaxsync-rel-item[data-id="+n+"]"),i=s.children('input[type="checkbox"]');s.addClass("disabled"),i.prop({disabled:!0}),_(a,t)}),g(e,a))},_=function(e,n){var s=n.id,i=n.text,c=n.parent;0==c?e.push({id:s,text:i,children:[]}):$.each(e,function(e,t){if(c==t.id)return t.children.push({id:s,text:i,children:[]}),!1;t.children&&t.children.length&&_(t.children,n)})},g=function(s,e){e.length&&$.each(e,function(e,t){var n=i({id:t.id,text:t.text,children:t.children});s.find(r("values")).append(n)})},b=function(e){var t=e.closest(d.relationship_fields);if(e.hasClass("disabled"))return!1;e.addClass("disabled");var n=i({id:e.data("id"),text:e.children(".val").text()});t.find(r("values")).append(n)},k=function(e){var t=e.closest(d.relationship_fields),n=e.data("id"),s=e.closest("li"),i=s.children("ul"),c=s.siblings(),a=t.find(r("choices")).find("li .mstaxsync-rel-item[data-id="+n+"]"),l=_mstaxsync.settings.advanced_treeview;c.length||s.parent("ul").hasClass("list")||i.length||s.unwrap("ul"),i.length?(s.children("div").remove(),i.children("li").unwrap("ul").unwrap("li")):s.remove(),a.removeClass("disabled"),l.length&&a.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})},C=function(e){var t=e.closest(".mstaxsync-rel-item"),n=t.children("input");t.addClass("editing"),n.focus()},w=function(e){var t=e.closest(".mstaxsync-rel-item"),n=t.children(".val"),s=t.children("input");s.val().length&&(n.text(s.val()),s.attr("placeholder",n.text()),s.val(""),S(t.closest("li"))),t.removeClass("editing")},j=function(e){"13"==(e.keyCode?e.keyCode:e.which)&&w($(e.target)),e.stopPropagation()},T=function(e){var t=e.closest(".mstaxsync-rel-item");t.children("input").val(""),t.removeClass("editing")},P=function(s){var e=s.closest(d.relationship_fields),t=s.data("nonce"),n=s.closest(".mstaxsync-rel-item"),i=n.data("id"),c=n.data("synced"),a=e.find(r("choices")).find("li .mstaxsync-rel-item[data-id="+c+"]"),l=_mstaxsync.settings.advanced_treeview;_mstaxsync.settings.detach_terms&&confirm(_mstaxsync.strings.confirm_detach)&&(s.addClass("rotate"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"detach_taxonomy_term",nonce:t,main_id:c,local_id:i},success:function(e){s.remove(),n.data("synced",""),a.removeClass("disabled"),a.data("synced",""),l.length&&a.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})},error:function(e,t,n){s.removeClass("rotate")}}))},A=function(e){var t=e.closest(d.relationship_fields),n=e.data("nonce"),s=e.closest(".mstaxsync-rel-item"),i=t.data("name"),c=s.data("id"),a=s.data("synced"),l=_mstaxsync.settings.advanced_treeview,o=_mstaxsync.settings.delete_terms;s.children(".synced");o&&confirm(_mstaxsync.strings.confirm_delete)&&(s.addClass("removing"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"delete_taxonomy_term",nonce:n,taxonomy:i,main_id:a,local_id:c},success:function(e){a&&(choice=t.find(r("choices")).find("li .mstaxsync-rel-item[data-id="+a+"]"),choice.removeClass("disabled"),choice.data("synced",""),l.length&&choice.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})),s.css("opacity","0"),setTimeout(function(){k(s)},500)},error:function(e,t,n){s.removeClass("removing")}}))},B=function(e){var t=e.data("nonce"),n=D(),s=$(".submit .ajax-loading"),i=$(".submit").next(".result"),c=[];s.css("visibility","visible"),i.html("").hide(),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"taxonomy_terms_sync",nonce:t,taxonomy_terms:n},success:function(e){O(e),Q(e,c)},error:function(e,t,n){c.push(_mstaxsync.strings.relationship_internal_server_error_str)},complete:function(e,t){s.css("visibility","hidden"),i.show().html(c.join("<br />"))}})},D=function(){return taxonomyTerms=[],$.each(d.relationship_fields,function(){var e=$(this).find(r("values")).children("li"),t=[];e.length&&(e.each(function(){E(t,$(this),0)}),taxonomyTerms.push({taxonomy:$(this).data("name"),terms:t}))}),taxonomyTerms},E=function(e,t,n){var s=t.find(".mstaxsync-rel-item").first(),i=s.data("id"),c=s.children(".val").text(),a=t.hasClass("new")?"main":"local",l=t.children("ul").children("li");e.push({id:i,name:c,source:a,parent:n}),l.length&&(n=i,l.each(function(){E(e,$(this),n)}))},O=function(e){var c=_mstaxsync.settings.advanced_treeview;Object.keys(e.rs_fields).length&&$.each(e.rs_fields,function(e,t){var n=$('.mstaxsync-relationship[data-name="'+e+'"]'),s=t.choices,i=t.values;s.length&&(n.find(r("choices")).html(s),c.length&&a()),i.length&&n.find(r("values")).html(i)})},Q=function(e,n){e.errors.length||n.push(_mstaxsync.strings.relationship_success_str),e.main.length&&n.push(e.main.length+" "+_mstaxsync.strings.relationship_main_terms_str),e.local.length&&n.push(e.local.length+" "+_mstaxsync.strings.relationship_local_terms_str),e.errors.length&&(n.push(_mstaxsync.strings.relationship_errors_str),$.each(e.errors,function(e,t){n.push(_mstaxsync.strings.relationship_error_str+" #"+t.code+": "+t.description)}))},S=function(e){var t=e.find(".mstaxsync-rel-item").first(),n=t.children(".val"),s=t.children(".ind"),i=t.children(".edit");e.addClass("changed"),s.length||(s=$('<span class="ind">('+_mstaxsync.strings.relationship_changed_item_str+")</span>"),i.length?s.insertBefore(i):s.insertAfter(n))},q=function(){r("values").nestedSortable({listType:"ul",items:"li",handle:"div",toleranceElement:"> div",opacity:.6,revert:250,rtl:d.rtl,relocate:function(e,t){S(t.item)}})},z=function(){F()},F=function(){d.single_post_meta_box.length&&(d.single_post_meta_box.find(".check-all").click(function(){G($(this))}),d.single_post_meta_box.find(".uncheck-all").click(function(){H($(this))}))},G=function(e){e.closest(d.single_post_meta_box).find(".synced-sites input.unsynced-post").prop("checked",!0)},H=function(e){e.closest(d.single_post_meta_box).find(".synced-sites input.unsynced-post").prop("checked",!1)};return e}();mstaxsync.init();