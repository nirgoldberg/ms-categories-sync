/*! ms-tax-sync 2020-01-22 */

var $=jQuery,mstaxsync=function(){function r(t){return $("."+t+"-list")}var t={},d={relationship_fields:$(".mstaxsync-relationship"),single_post_meta_box:$("#mstaxsync_single_post_broadcast"),rtl:$("html").attr("dir")&&"rtl"==$("html").attr("dir"),totalImported:{},totalResynced:{}},i=function(t){var s=_mstaxsync.settings.edit_terms,n=[];return t.children&&t.children.length&&($.each(t.children,function(t,s){n.push(i({id:s.id,text:s.text,children:s.children}))}),n=n.join("")),['<li class="new">',"<div>",'<span class="mstaxsync-rel-item" data-id="'+t.id+'">','<span class="val">'+t.text+"</span>",s?'<input type="text" placeholder="'+t.text+'" />':"",'<span class="ind">('+_mstaxsync.strings.relationship_new_item_str+")</span>",s?'<span class="edit dashicons dashicons-edit"></span><span class="ok dashicons dashicons-yes"></span><span class="cancel dashicons dashicons-no"></span>':"",'<span class="remove dashicons dashicons-minus"></span>',"</span>","</div>",n.length?"<ul>"+n+"</ul>":"","</li>"].join("")};t.init=function(){s(),Q(),K(),V()};var s=function(){d.relationship_fields.length&&(_mstaxsync.settings.advanced_treeview.length?n():e(),a(),$('#mstaxsync-taxonomies input[name="submit"]').click(function(t){t.preventDefault(),E($(this))}),O())},n=function(){c(),$("body").on("click",".choices-list li .mstaxsync-rel-item",function(){o($(this))}),$("body").on("click",'.choices-list li .mstaxsync-rel-item input[type="checkbox"]',function(t){t.stopPropagation(),m($(this).closest(d.relationship_fields))}),$("body").on("click",".choices-list li .mstaxsync-rel-item .check-all",function(t){t.stopPropagation(),l($(this))}),$("body").on("click",".choices-list li .mstaxsync-rel-item .uncheck-all",function(t){t.stopPropagation(),h($(this))}),$("body").on("click",".advanced-treeview-controls .check-all",function(t){p($(this))}),$("body").on("click",".advanced-treeview-controls .uncheck-all",function(t){u($(this))}),$("body").on("click",".advanced-treeview-controls .add-items",function(){f($(this))})},e=function(){$("body").on("click",".choices-list li .mstaxsync-rel-item",function(){b($(this))})},a=function(){$("body").on("click",".values-list li .remove",function(){k($(this).parent(".mstaxsync-rel-item"))}),$("body").on("click",".values-list li .edit",function(){C($(this))}),$("body").on("click",".values-list li .ok",function(){j($(this))}),$("body").on("keypress",".values-list li input",function(t){w(t)}),$("body").on("click",".values-list li .cancel",function(){T($(this))}),$("body").on("click",".values-list li .synced",function(){P($(this))}),$("body").on("click",".values-list li .trash",function(){I($(this))})},c=function(){var t=$('.mstaxsync-rel-item.disabled input[type="checkbox"]');t.length&&t.prop({checked:!0,disabled:!0})},o=function(t){var s=t.closest(d.relationship_fields),n=t.children('input[type="checkbox"]');if(t.hasClass("disabled"))return!1;n.prop("checked",!n.prop("checked")),m(s)},l=function(t){var s=t.closest(d.relationship_fields);t.closest("li").find('input[type="checkbox"]').prop("checked",!0),m(s)},h=function(t){var s=t.closest(d.relationship_fields);t.closest("li").find('input[type="checkbox"]').each(function(){var t=$(this);t.parent(".mstaxsync-rel-item").hasClass("disabled")||t.prop("checked",!1)}),m(s)},p=function(t){var s=t.closest(".mstaxsync-taxonomy-terms-box").children(d.relationship_fields),n=s.find(r("choices")).find('input[type="checkbox"]');n.length&&n.prop("checked",!0),m(s)},u=function(t){var s=t.closest(".mstaxsync-taxonomy-terms-box").children(d.relationship_fields),n=s.find(r("choices")).find('input[type="checkbox"]');n.length&&(n.each(function(){var t=$(this);t.parent(".mstaxsync-rel-item").hasClass("disabled")||t.prop("checked",!1)}),m(s))},m=function(t){var s=t.find(r("choices")).find('input[type="checkbox"]'),n=t.next(".advanced-treeview-controls").children(".add-items"),e=!1;s.length&&s.each(function(){var t=$(this);if(!t.parent(".mstaxsync-rel-item").hasClass("disabled")&&t.prop("checked"))return!(e=!0)}),e?n.addClass("enabled"):n.removeClass("enabled")},f=function(t){if(t.hasClass("enabled")){var s=t.closest(".mstaxsync-taxonomy-terms-box").children(d.relationship_fields),n=s.find(r("choices")).children("li"),e=[],i=[];n.length&&n.each(function(){y(e,i,$(this),0)}),_(s,i)}},y=function(t,s,n,e){var i=n.find(".mstaxsync-rel-item").first(),a=i.data("id"),c=i.children('input[type="checkbox"]'),o=i.children(".val").text(),l=n.children("ul").children("li"),r=x(t,e),d=!i.hasClass("disabled")&&c.prop("checked");t.push({id:a,parent:e,valid:d}),d&&s.push({id:a,text:o,parent:r}),l.length&&(e=a,l.each(function(){y(t,s,$(this),e)}))},x=function(t,s){if(0==s)return 0;var n=$.grep(t,function(t){return t.id==s});if(n.length){var e=n[0].parent;return n[0].valid?s:x(t,e)}return 0},_=function(t,s){var a=t.find(r("choices")),n=t.next(".advanced-treeview-controls").children(".add-items"),c=[];n.removeClass("enabled"),s.length&&($.each(s,function(t,s){var n=s.id,e=a.find("li .mstaxsync-rel-item[data-id="+n+"]"),i=e.children('input[type="checkbox"]');e.addClass("disabled"),i.prop({disabled:!0}),v(c,s)}),g(t,c))},v=function(t,n){var e=n.id,i=n.text,a=n.parent;0==a?t.push({id:e,text:i,children:[]}):$.each(t,function(t,s){if(a==s.id)return s.children.push({id:e,text:i,children:[]}),!1;s.children&&s.children.length&&v(s.children,n)})},g=function(e,t){t.length&&$.each(t,function(t,s){var n=i({id:s.id,text:s.text,children:s.children});e.find(r("values")).append(n)})},b=function(t){var s=t.closest(d.relationship_fields);if(t.hasClass("disabled"))return!1;t.addClass("disabled");var n=i({id:t.data("id"),text:t.children(".val").text()});s.find(r("values")).append(n)},k=function(t){var s=t.closest(d.relationship_fields),n=t.data("id"),e=t.closest("li"),i=e.children("ul"),a=e.siblings(),c=s.find(r("choices")).find("li .mstaxsync-rel-item[data-id="+n+"]"),o=_mstaxsync.settings.advanced_treeview;a.length||e.parent("ul").hasClass("list")||i.length||e.unwrap("ul"),i.length?(e.children("div").remove(),i.children("li").unwrap("ul").unwrap("li")):e.remove(),c.removeClass("disabled"),o.length&&c.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})},C=function(t){var s=t.closest(".mstaxsync-rel-item"),n=s.children("input");s.addClass("editing"),n.focus()},j=function(t){var s=t.closest(".mstaxsync-rel-item"),n=s.children(".val"),e=s.children("input");e.val().length&&(n.text(e.val()),e.attr("placeholder",n.text()),e.val(""),D(s.closest("li"))),s.removeClass("editing")},w=function(t){"13"==(t.keyCode?t.keyCode:t.which)&&j($(t.target)),t.stopPropagation()},T=function(t){var s=t.closest(".mstaxsync-rel-item");s.children("input").val(""),s.removeClass("editing")},P=function(e){var t=e.closest(d.relationship_fields),s=e.data("nonce"),n=e.closest(".mstaxsync-rel-item"),i=n.data("id"),a=n.data("synced"),c=t.find(r("choices")).find("li .mstaxsync-rel-item[data-id="+a+"]"),o=_mstaxsync.settings.advanced_treeview;_mstaxsync.settings.detach_terms&&confirm(_mstaxsync.strings.confirm_detach)&&(e.addClass("rotate"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"detach_taxonomy_term",nonce:s,main_id:a,local_id:i},success:function(t){e.remove(),n.data("synced",""),c.removeClass("disabled"),c.data("synced",""),o.length&&c.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})},error:function(t,s,n){e.removeClass("rotate")}}))},I=function(t){var s=t.closest(d.relationship_fields),n=t.data("nonce"),e=t.closest(".mstaxsync-rel-item"),i=s.data("name"),a=e.data("id"),c=e.data("synced"),o=_mstaxsync.settings.advanced_treeview,l=_mstaxsync.settings.delete_terms;e.children(".synced");l&&confirm(_mstaxsync.strings.confirm_delete)&&(e.addClass("removing"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"delete_taxonomy_term",nonce:n,taxonomy:i,main_id:c,local_id:a},success:function(t){c&&(choice=s.find(r("choices")).find("li .mstaxsync-rel-item[data-id="+c+"]"),choice.removeClass("disabled"),choice.data("synced",""),o.length&&choice.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})),e.css("opacity","0"),setTimeout(function(){k(e)},500)},error:function(t,s,n){e.removeClass("removing")}}))},E=function(t){var s=t.data("nonce"),n=R(),e=$(".submit .ajax-loading"),i=$(".submit").next(".result"),a=[];e.css("visibility","visible"),i.html("").hide(),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"taxonomy_terms_sync",nonce:s,taxonomy_terms:n},success:function(t){q(t),B(t,a)},error:function(t,s,n){a.push(_mstaxsync.strings.relationship_internal_server_error_str)},complete:function(t,s){e.css("visibility","hidden"),i.show().html(a.join("<br />"))}})},R=function(){return taxonomyTerms=[],$.each(d.relationship_fields,function(){var t=$(this).find(r("values")).children("li"),s=[];t.length&&(t.each(function(){A(s,$(this),0)}),taxonomyTerms.push({taxonomy:$(this).data("name"),terms:s}))}),taxonomyTerms},A=function(t,s,n){var e=s.find(".mstaxsync-rel-item").first(),i=e.data("id"),a=e.children(".val").text(),c=s.hasClass("new")?"main":"local",o=s.children("ul").children("li");t.push({id:i,name:a,source:c,parent:n}),o.length&&(n=i,o.each(function(){A(t,$(this),n)}))},q=function(t){var a=_mstaxsync.settings.advanced_treeview;Object.keys(t.rs_fields).length&&$.each(t.rs_fields,function(t,s){var n=$('.mstaxsync-relationship[data-name="'+t+'"]'),e=s.choices,i=s.values;e.length&&(n.find(r("choices")).html(e),a.length&&c()),i.length&&n.find(r("values")).html(i)})},B=function(t,n){t.errors.length||n.push(_mstaxsync.strings.relationship_success_str),t.main.length&&n.push(t.main.length+" "+_mstaxsync.strings.relationship_main_terms_str),t.local.length&&n.push(t.local.length+" "+_mstaxsync.strings.relationship_local_terms_str),t.errors.length&&(n.push(_mstaxsync.strings.relationship_errors_str),$.each(t.errors,function(t,s){n.push(_mstaxsync.strings.relationship_error_str+" #"+s.code+": "+s.description)}))},D=function(t){var s=t.find(".mstaxsync-rel-item").first(),n=s.children(".val"),e=s.children(".ind"),i=s.children(".edit");t.addClass("changed"),e.length||(e=$('<span class="ind">('+_mstaxsync.strings.relationship_changed_item_str+")</span>"),i.length?e.insertBefore(i):e.insertAfter(n))},O=function(){r("values").nestedSortable({listType:"ul",items:"li",handle:"div",toleranceElement:"> div",opacity:.6,revert:250,rtl:d.rtl,relocate:function(t,s){D(s.item)}})},Q=function(){S(),G(),J()},S=function(){d.single_post_meta_box.length&&(d.single_post_meta_box.find(".check-all").click(function(){z($(this))}),d.single_post_meta_box.find(".uncheck-all").click(function(){F($(this))}))},z=function(t){t.closest(d.single_post_meta_box).find(".synced-sites input.unsynced-post").prop("checked",!0)},F=function(t){t.closest(d.single_post_meta_box).find(".synced-sites input.unsynced-post").prop("checked",!1)},G=function(){if("undefined"!=typeof inlineEditPost){var n=inlineEditPost.edit;inlineEditPost.edit=function(t){n.apply(this,arguments);var s=0;"object"==typeof t&&(s=parseInt(this.getId(t))),0<s&&H(s)}}},H=function(t){var s=$("#edit-"+t),n=$("#post-"+t).find(".column-mstaxsync_synced li"),e=s.find(".mstaxsync-broadcast-checklist li"),i=[];n.length&&e.length&&(n.each(function(){i.push($(this).attr("id"))}),e.each(function(){var t=$(this).attr("id"),s=!1,n=!1;-1<$.inArray(t,i)&&(n=s=!0),$(this).find("input").prop({checked:s,disabled:n})}))},J=function(){$("body").on("click",'input[name="bulk_edit"]',function(){$(this).after('<span class="spinner is-active"></span>');var t=$("#mstaxsync_quick_edit_post_broadcast").val(),s=$("tr#bulk-edit"),n=[],e=s.find(".mstaxsync-broadcast-checklist li"),i=[];s.find("#bulk-titles").children().each(function(){n.push($(this).attr("id").replace(/^(ttle)/i,""))}),n.length&&(e.each(function(){checked=$(this).find("input").attr("checked"),checked&&(id=$(this).attr("id").replace(/^(site-)/i,""),i.push(id))}),$.ajax({type:"post",url:_mstaxsync.ajaxurl,async:!1,cache:!1,data:{action:"bulk_broadcast",nonce:t,post_ids:n,dest_sites:i}}))})},K=function(){$("body").on("click",".mstaxsync-import",function(){L($(this))})},L=function(t){var s=t.parent(),n=t.data("nonce"),e=t.data("id"),i=t.data("term-count"),a=_mstaxsync.settings.import_posts,c=1<i?_mstaxsync.strings.confirm_import.replace("%s",i):_mstaxsync.strings.confirm_single_import;!s.hasClass("done")&&!s.hasClass("active")&&a&&confirm(c)&&(s.addClass("active"),d.totalImported[e]=0,M(s,e,n))},M=function(e,s,n){e&&s&&n&&$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"prepare_taxonomy_term_posts_import",nonce:n,main_term_id:s},success:function(t){e.children(".mstaxsync-import-result").html(_mstaxsync.strings.success_import+0),t.posts&&t.posts.length?N(e,s,t.posts,n):(e.addClass("done"),e.removeClass("active"))},error:function(t,s,n){e.children(".mstaxsync-import-result").html(_mstaxsync.strings.failed_import),e.removeClass("active")}})},N=function(n,e,i,a){i&&i.length&&$.each(i,function(t,s){U(n,e,s,t,i.length,a)})},U=function(n,s,t,e,i,a){t&&$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"import_post",nonce:a,post:t},success:function(t){t.length&&(d.totalImported[s]++,n.children(".mstaxsync-import-result").html(_mstaxsync.strings.success_import+d.totalImported[s]))},complete:function(t,s){e+1==i&&(n.addClass("done"),n.removeClass("active"))}})},V=function(){$("body").on("click",".mstaxsync-resync-posts",function(){W($(this))})},W=function(t){var s=_mstaxsync.settings.resync_posts,n=_mstaxsync.strings.confirm_resync;!t.hasClass("disabled")&&!t.hasClass("active")&&s&&confirm(n)&&(t.addClass("active"),X(t))},X=function(e){var s=e.data("nonce"),i=$(".resync-posts-summary");$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"prepare_posts_resync",nonce:s},success:function(t){t.posts&&t.posts.length?(i.html(_mstaxsync.strings.synced_posts_found.replace("%s",t.posts.length)),d.totalResynced=0,Y(e,t.posts,s)):(i.html(_mstaxsync.strings.no_synced_posts),e.addClass("disabled"),e.removeClass("active"))},error:function(t,s,n){i.html(_mstaxsync.strings.failed_resync),e.removeClass("active")}})},Y=function(n,e,i){e&&e.length&&$.each(e,function(t,s){Z(n,s,t,e.length,i)})},Z=function(n,t,e,i,s){if(t){var a=$(".resync-posts-summary"),c=$(".resync-posts-result");$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"resync_post",nonce:s,post:t},success:function(t){var s=tt(t);s&&(c.append(s),d.totalResynced++)},complete:function(t,s){e+1==i&&(n.addClass("disabled"),n.removeClass("active"),a.append("<br />"+_mstaxsync.strings.total_posts_resynced.replace("%s",d.totalResynced)))}})}},tt=function(t){var n="";return t.post_title&&t.post_title.length&&t.taxonomies&&t.taxonomies.length&&(n+='<div class="mstaxsync-resynced-post">',n+='<div class="mstaxsync-resynced-post-title">'+t.post_title+"</div>",$.each(t.taxonomies[0],function(t,s){s.label&&s.terms&&(n+='<p class="mstaxsync-resynced-post-taxonomy-title">'+s.label+"</p><ul>",$.each(s.terms,function(t,s){n+="<li>"+s+"</li>"}),n+="</ul>")}),n+="</div>"),n};return t}();mstaxsync.init();