/*! ms-tax-sync 2019-10-10 */

var $=jQuery,mstaxsync={params:{relationship_fields:$(".mstaxsync-relationship"),rtl:$("html").attr("dir")&&"rtl"==$("html").attr("dir")},$list:function(s){return $("."+s+"-list")},rsGetInputName:function(s){return s.data("name")},rsNewValue:function(s){var t=_mstaxsync.settings.edit_terms;return['<li class="new">',"<div>",'<span class="mstaxsync-rel-item" data-id="'+s.id+'">','<span class="val">'+s.text+"</span>",t?'<input type="text" placeholder="'+s.text+'" />':"",'<span class="ind">('+_mstaxsync.strings.relationship_new_item_str+")</span>",t?'<span class="edit dashicons dashicons-edit"></span><span class="ok dashicons dashicons-yes"></span><span class="cancel dashicons dashicons-no"></span>':"",'<span class="remove dashicons dashicons-minus"></span>',"</span>","</div>","</li>"].join("")},init:function(){mstaxsync.relationship()},relationship:function(){mstaxsync.params.relationship_fields.length&&($("body").on("click",".choices-list li .mstaxsync-rel-item",function(){mstaxsync.rsOnClickAdd($(this))}),$("body").on("click",".values-list li .remove",function(){mstaxsync.rsOnClickRemove($(this).parent(".mstaxsync-rel-item"))}),$("body").on("click",".values-list li .edit",function(){mstaxsync.rsOnClickEdit($(this))}),$("body").on("click",".values-list li .ok",function(){mstaxsync.rsOnClickSubmitEdit($(this))}),$("body").on("keypress",".values-list li input",function(s){mstaxsync.rsOnKeypressSubmitEdit(s)}),$("body").on("click",".values-list li .cancel",function(){mstaxsync.rsOnClickCancelEdit($(this))}),$("body").on("click",".values-list li .synced",function(){mstaxsync.rsOnClickDetach($(this))}),$("body").on("click",".values-list li .trash",function(){mstaxsync.rsOnClickDelete($(this))}),$('#mstaxsync-taxonomies input[name="submit"]').click(function(s){s.preventDefault(),mstaxsync.rsOnSubmit($(this))}),mstaxsync.relationshipNestedSortable())},rsOnClickAdd:function(s){var t=s.closest(mstaxsync.params.relationship_fields);if(s.hasClass("disabled"))return!1;s.addClass("disabled");var n=mstaxsync.rsNewValue({field:t,id:s.data("id"),text:s.children("span.val").text()});t.find(mstaxsync.$list("values")).append(n)},rsOnClickRemove:function(s){var t=s.closest(mstaxsync.params.relationship_fields),n=s.data("id"),i=s.closest("li"),a=i.children("ul"),e=i.siblings(),c=t.find(mstaxsync.$list("choices")).find("li .mstaxsync-rel-item[data-id="+n+"]");e.length||i.parent("ul").hasClass("list")||a.length||i.unwrap("ul"),a.length?(i.children("div").remove(),a.children("li").unwrap("ul").unwrap("li")):i.remove(),c.removeClass("disabled")},rsOnClickEdit:function(s){var t=s.closest(".mstaxsync-rel-item"),n=t.children("input");t.addClass("editing"),n.focus()},rsOnClickSubmitEdit:function(s){var t=s.closest(".mstaxsync-rel-item"),n=t.children("span.val"),i=t.children("input");i.val().length&&(n.text(i.val()),i.attr("placeholder",n.text()),i.val(""),mstaxsync.rsIndicateChanged(t.closest("li"))),t.removeClass("editing")},rsOnKeypressSubmitEdit:function(s){"13"==(s.keyCode?s.keyCode:s.which)&&mstaxsync.rsOnClickSubmitEdit($(s.target)),s.stopPropagation()},rsOnClickCancelEdit:function(s){var t=s.closest(".mstaxsync-rel-item");t.children("input").val(""),t.removeClass("editing")},rsOnClickDetach:function(i){var s=i.closest(mstaxsync.params.relationship_fields),t=i.data("nonce"),n=i.closest(".mstaxsync-rel-item"),a=n.data("id"),e=n.data("synced"),c=s.find(mstaxsync.$list("choices")).find("li .mstaxsync-rel-item[data-id="+e+"]");detach_terms=_mstaxsync.settings.detach_terms,detach_terms&&confirm(_mstaxsync.strings.confirm_detach)&&(i.addClass("rotate"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"detach_taxonomy_term",nonce:t,main_id:e,local_id:a},success:function(s){i.remove(),n.data("synced",""),c.removeClass("disabled"),c.data("synced","")},error:function(s,t,n){i.removeClass("rotate")}}))},rsOnClickDelete:function(s){var t=s.closest(mstaxsync.params.relationship_fields),n=s.data("nonce"),i=s.closest(".mstaxsync-rel-item"),a=t.data("name"),e=i.data("id"),c=i.data("synced"),l=_mstaxsync.settings.delete_terms;i.children(".synced");l&&confirm(_mstaxsync.strings.confirm_delete)&&(i.addClass("removing"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"delete_taxonomy_term",nonce:n,taxonomy:a,main_id:c,local_id:e},success:function(s){c&&(choice=t.find(mstaxsync.$list("choices")).find("li .mstaxsync-rel-item[data-id="+c+"]"),choice.removeClass("disabled"),choice.data("synced","")),i.css("opacity","0"),setTimeout(function(){mstaxsync.rsOnClickRemove(i)},500)},error:function(s,t,n){i.removeClass("removing")}}))},rsOnSubmit:function(s){var t=s.data("nonce"),n=mstaxsync.rsGroupTaxonomyTerms(),i=$(".submit .ajax-loading"),a=$(".submit").next(".result"),e=[];i.css("visibility","visible"),a.html("").hide(),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"taxonomy_terms_sync",nonce:t,taxonomy_terms:n},success:function(s){mstaxsync.rsRefreshLists(s),mstaxsync.rsBuildResultMsg(s,e)},error:function(s,t,n){e.push(_mstaxsync.strings.relationship_internal_server_error_str)},complete:function(s,t){i.css("visibility","hidden"),a.show().html(e.join("<br />"))}})},rsGroupTaxonomyTerms:function(){return taxonomyTerms=[],$.each(mstaxsync.params.relationship_fields,function(){var s=$(this).find(mstaxsync.$list("values")).children("li"),t=[];s.length&&(s.each(function(){mstaxsync.rsBuildTaxonomyTerms(t,$(this),0)}),taxonomyTerms.push({taxonomy:$(this).data("name"),terms:t}))}),taxonomyTerms},rsBuildTaxonomyTerms:function(s,t,n){var i=t.find(".mstaxsync-rel-item").first(),a=i.data("id"),e=i.children(".val").text(),c=t.hasClass("new")?"main":"local",l=t.children("ul").children("li");s.push({id:a,name:e,source:c,parent:n}),l.length&&(n=a,l.each(function(){mstaxsync.rsBuildTaxonomyTerms(s,$(this),n)}))},rsRefreshLists:function(s){Object.keys(s.rs_fields).length&&$.each(s.rs_fields,function(s,t){var n=$('.mstaxsync-relationship[data-name="'+s+'"]'),i=t.choices,a=t.values;i.length&&n.find(mstaxsync.$list("choices")).html(i),a.length&&n.find(mstaxsync.$list("values")).html(a)})},rsBuildResultMsg:function(s,n){s.errors.length||n.push(_mstaxsync.strings.relationship_success_str),s.main.length&&n.push(s.main.length+" "+_mstaxsync.strings.relationship_main_terms_str),s.local.length&&n.push(s.local.length+" "+_mstaxsync.strings.relationship_local_terms_str),s.errors.length&&(n.push(_mstaxsync.strings.relationship_errors_str),$.each(s.errors,function(s,t){n.push(_mstaxsync.strings.relationship_error_str+" #"+t.code+": "+t.description)}))},rsIndicateChanged:function(s){var t=s.find(".mstaxsync-rel-item").first(),n=t.children("span.val"),i=t.children("span.ind"),a=t.children("span.edit");s.addClass("changed"),i.length||(i=$('<span class="ind">('+_mstaxsync.strings.relationship_changed_item_str+")</span>"),a.length?i.insertBefore(a):i.insertAfter(n))},relationshipNestedSortable:function(){mstaxsync.$list("values").nestedSortable({listType:"ul",items:"li",handle:"div",toleranceElement:"> div",opacity:.6,revert:250,rtl:mstaxsync.params.rtl,relocate:function(s,t){mstaxsync.rsIndicateChanged(t.item)}})}};$(mstaxsync.init);