/*! ms-tax-sync 2019-12-12 */

var $=jQuery,mstaxsync=function(){function d(t){return $("."+t+"-list")}var t={},r={relationship_fields:$(".mstaxsync-relationship"),single_post_meta_box:$("#mstaxsync_single_post_broadcast"),rtl:$("html").attr("dir")&&"rtl"==$("html").attr("dir")},s=function(t){var e=_mstaxsync.settings.edit_terms,n=[];return t.children&&t.children.length&&($.each(t.children,function(t,e){n.push(s({id:e.id,text:e.text,children:e.children}))}),n=n.join("")),['<li class="new">',"<div>",'<span class="mstaxsync-rel-item" data-id="'+t.id+'">','<span class="val">'+t.text+"</span>",e?'<input type="text" placeholder="'+t.text+'" />':"",'<span class="ind">('+_mstaxsync.strings.relationship_new_item_str+")</span>",e?'<span class="edit dashicons dashicons-edit"></span><span class="ok dashicons dashicons-yes"></span><span class="cancel dashicons dashicons-no"></span>':"",'<span class="remove dashicons dashicons-minus"></span>',"</span>","</div>",n.length?"<ul>"+n+"</ul>":"","</li>"].join("")};t.init=function(){e(),S()};var e=function(){r.relationship_fields.length&&(_mstaxsync.settings.advanced_treeview.length?n():i(),c(),$('#mstaxsync-taxonomies input[name="submit"]').click(function(t){t.preventDefault(),A($(this))}),Q())},n=function(){a(),$("body").on("click",".choices-list li .mstaxsync-rel-item",function(){l($(this))}),$("body").on("click",'.choices-list li .mstaxsync-rel-item input[type="checkbox"]',function(t){t.stopPropagation(),m($(this).closest(r.relationship_fields))}),$("body").on("click",".choices-list li .mstaxsync-rel-item .check-all",function(t){t.stopPropagation(),o($(this))}),$("body").on("click",".choices-list li .mstaxsync-rel-item .uncheck-all",function(t){t.stopPropagation(),h($(this))}),$("body").on("click",".advanced-treeview-controls .check-all",function(t){u($(this))}),$("body").on("click",".advanced-treeview-controls .uncheck-all",function(t){p($(this))}),$("body").on("click",".advanced-treeview-controls .add-items",function(){f($(this))})},i=function(){$("body").on("click",".choices-list li .mstaxsync-rel-item",function(){g($(this))})},c=function(){$("body").on("click",".values-list li .remove",function(){k($(this).parent(".mstaxsync-rel-item"))}),$("body").on("click",".values-list li .edit",function(){C($(this))}),$("body").on("click",".values-list li .ok",function(){j($(this))}),$("body").on("keypress",".values-list li input",function(t){w(t)}),$("body").on("click",".values-list li .cancel",function(){T($(this))}),$("body").on("click",".values-list li .synced",function(){P($(this))}),$("body").on("click",".values-list li .trash",function(){E($(this))})},a=function(){var t=$('.mstaxsync-rel-item.disabled input[type="checkbox"]');t.length&&t.prop({checked:!0,disabled:!0})},l=function(t){var e=t.closest(r.relationship_fields),n=t.children('input[type="checkbox"]');if(t.hasClass("disabled"))return!1;n.prop("checked",!n.prop("checked")),m(e)},o=function(t){var e=t.closest(r.relationship_fields);t.closest("li").find('input[type="checkbox"]').prop("checked",!0),m(e)},h=function(t){var e=t.closest(r.relationship_fields);t.closest("li").find('input[type="checkbox"]').each(function(){var t=$(this);t.parent(".mstaxsync-rel-item").hasClass("disabled")||t.prop("checked",!1)}),m(e)},u=function(t){var e=t.closest(".mstaxsync-taxonomy-terms-box").children(r.relationship_fields),n=e.find(d("choices")).find('input[type="checkbox"]');n.length&&n.prop("checked",!0),m(e)},p=function(t){var e=t.closest(".mstaxsync-taxonomy-terms-box").children(r.relationship_fields),n=e.find(d("choices")).find('input[type="checkbox"]');n.length&&(n.each(function(){var t=$(this);t.parent(".mstaxsync-rel-item").hasClass("disabled")||t.prop("checked",!1)}),m(e))},m=function(t){var e=t.find(d("choices")).find('input[type="checkbox"]'),n=t.next(".advanced-treeview-controls").children(".add-items"),i=!1;e.length&&e.each(function(){var t=$(this);if(!t.parent(".mstaxsync-rel-item").hasClass("disabled")&&t.prop("checked"))return!(i=!0)}),i?n.addClass("enabled"):n.removeClass("enabled")},f=function(t){if(t.hasClass("enabled")){var e=t.closest(".mstaxsync-taxonomy-terms-box").children(r.relationship_fields),n=e.find(d("choices")).children("li"),i=[],s=[];n.length&&n.each(function(){y(i,s,$(this),0)}),v(e,s)}},y=function(t,e,n,i){var s=n.find(".mstaxsync-rel-item").first(),c=s.data("id"),a=s.children('input[type="checkbox"]'),l=s.children(".val").text(),o=n.children("ul").children("li"),d=x(t,i),r=!s.hasClass("disabled")&&a.prop("checked");t.push({id:c,parent:i,valid:r}),r&&e.push({id:c,text:l,parent:d}),o.length&&(i=c,o.each(function(){y(t,e,$(this),i)}))},x=function(t,e){if(0==e)return 0;var n=$.grep(t,function(t){return t.id==e});if(n.length){var i=n[0].parent;return n[0].valid?e:x(t,i)}return 0},v=function(t,e){var c=t.find(d("choices")),n=t.next(".advanced-treeview-controls").children(".add-items"),a=[];n.removeClass("enabled"),e.length&&($.each(e,function(t,e){var n=e.id,i=c.find("li .mstaxsync-rel-item[data-id="+n+"]"),s=i.children('input[type="checkbox"]');i.addClass("disabled"),s.prop({disabled:!0}),_(a,e)}),b(t,a))},_=function(t,n){var i=n.id,s=n.text,c=n.parent;0==c?t.push({id:i,text:s,children:[]}):$.each(t,function(t,e){if(c==e.id)return e.children.push({id:i,text:s,children:[]}),!1;e.children&&e.children.length&&_(e.children,n)})},b=function(i,t){t.length&&$.each(t,function(t,e){var n=s({id:e.id,text:e.text,children:e.children});i.find(d("values")).append(n)})},g=function(t){var e=t.closest(r.relationship_fields);if(t.hasClass("disabled"))return!1;t.addClass("disabled");var n=s({id:t.data("id"),text:t.children(".val").text()});e.find(d("values")).append(n)},k=function(t){var e=t.closest(r.relationship_fields),n=t.data("id"),i=t.closest("li"),s=i.children("ul"),c=i.siblings(),a=e.find(d("choices")).find("li .mstaxsync-rel-item[data-id="+n+"]"),l=_mstaxsync.settings.advanced_treeview;c.length||i.parent("ul").hasClass("list")||s.length||i.unwrap("ul"),s.length?(i.children("div").remove(),s.children("li").unwrap("ul").unwrap("li")):i.remove(),a.removeClass("disabled"),l.length&&a.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})},C=function(t){var e=t.closest(".mstaxsync-rel-item"),n=e.children("input");e.addClass("editing"),n.focus()},j=function(t){var e=t.closest(".mstaxsync-rel-item"),n=e.children(".val"),i=e.children("input");i.val().length&&(n.text(i.val()),i.attr("placeholder",n.text()),i.val(""),O(e.closest("li"))),e.removeClass("editing")},w=function(t){"13"==(t.keyCode?t.keyCode:t.which)&&j($(t.target)),t.stopPropagation()},T=function(t){var e=t.closest(".mstaxsync-rel-item");e.children("input").val(""),e.removeClass("editing")},P=function(i){var t=i.closest(r.relationship_fields),e=i.data("nonce"),n=i.closest(".mstaxsync-rel-item"),s=n.data("id"),c=n.data("synced"),a=t.find(d("choices")).find("li .mstaxsync-rel-item[data-id="+c+"]"),l=_mstaxsync.settings.advanced_treeview;_mstaxsync.settings.detach_terms&&confirm(_mstaxsync.strings.confirm_detach)&&(i.addClass("rotate"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"detach_taxonomy_term",nonce:e,main_id:c,local_id:s},success:function(t){i.remove(),n.data("synced",""),a.removeClass("disabled"),a.data("synced",""),l.length&&a.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})},error:function(t,e,n){i.removeClass("rotate")}}))},E=function(t){var e=t.closest(r.relationship_fields),n=t.data("nonce"),i=t.closest(".mstaxsync-rel-item"),s=e.data("name"),c=i.data("id"),a=i.data("synced"),l=_mstaxsync.settings.advanced_treeview,o=_mstaxsync.settings.delete_terms;i.children(".synced");o&&confirm(_mstaxsync.strings.confirm_delete)&&(i.addClass("removing"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"delete_taxonomy_term",nonce:n,taxonomy:s,main_id:a,local_id:c},success:function(t){a&&(choice=e.find(d("choices")).find("li .mstaxsync-rel-item[data-id="+a+"]"),choice.removeClass("disabled"),choice.data("synced",""),l.length&&choice.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})),i.css("opacity","0"),setTimeout(function(){k(i)},500)},error:function(t,e,n){i.removeClass("removing")}}))},A=function(t){var e=t.data("nonce"),n=I(),i=$(".submit .ajax-loading"),s=$(".submit").next(".result"),c=[];i.css("visibility","visible"),s.html("").hide(),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"taxonomy_terms_sync",nonce:e,taxonomy_terms:n},success:function(t){B(t),D(t,c)},error:function(t,e,n){c.push(_mstaxsync.strings.relationship_internal_server_error_str)},complete:function(t,e){i.css("visibility","hidden"),s.show().html(c.join("<br />"))}})},I=function(){return taxonomyTerms=[],$.each(r.relationship_fields,function(){var t=$(this).find(d("values")).children("li"),e=[];t.length&&(t.each(function(){q(e,$(this),0)}),taxonomyTerms.push({taxonomy:$(this).data("name"),terms:e}))}),taxonomyTerms},q=function(t,e,n){var i=e.find(".mstaxsync-rel-item").first(),s=i.data("id"),c=i.children(".val").text(),a=e.hasClass("new")?"main":"local",l=e.children("ul").children("li");t.push({id:s,name:c,source:a,parent:n}),l.length&&(n=s,l.each(function(){q(t,$(this),n)}))},B=function(t){var c=_mstaxsync.settings.advanced_treeview;Object.keys(t.rs_fields).length&&$.each(t.rs_fields,function(t,e){var n=$('.mstaxsync-relationship[data-name="'+t+'"]'),i=e.choices,s=e.values;i.length&&(n.find(d("choices")).html(i),c.length&&a()),s.length&&n.find(d("values")).html(s)})},D=function(t,n){t.errors.length||n.push(_mstaxsync.strings.relationship_success_str),t.main.length&&n.push(t.main.length+" "+_mstaxsync.strings.relationship_main_terms_str),t.local.length&&n.push(t.local.length+" "+_mstaxsync.strings.relationship_local_terms_str),t.errors.length&&(n.push(_mstaxsync.strings.relationship_errors_str),$.each(t.errors,function(t,e){n.push(_mstaxsync.strings.relationship_error_str+" #"+e.code+": "+e.description)}))},O=function(t){var e=t.find(".mstaxsync-rel-item").first(),n=e.children(".val"),i=e.children(".ind"),s=e.children(".edit");t.addClass("changed"),i.length||(i=$('<span class="ind">('+_mstaxsync.strings.relationship_changed_item_str+")</span>"),s.length?i.insertBefore(s):i.insertAfter(n))},Q=function(){d("values").nestedSortable({listType:"ul",items:"li",handle:"div",toleranceElement:"> div",opacity:.6,revert:250,rtl:r.rtl,relocate:function(t,e){O(e.item)}})},S=function(){z(),H(),K()},z=function(){r.single_post_meta_box.length&&(r.single_post_meta_box.find(".check-all").click(function(){F($(this))}),r.single_post_meta_box.find(".uncheck-all").click(function(){G($(this))}))},F=function(t){t.closest(r.single_post_meta_box).find(".synced-sites input.unsynced-post").prop("checked",!0)},G=function(t){t.closest(r.single_post_meta_box).find(".synced-sites input.unsynced-post").prop("checked",!1)},H=function(){var n=inlineEditPost.edit;inlineEditPost.edit=function(t){n.apply(this,arguments);var e=0;"object"==typeof t&&(e=parseInt(this.getId(t))),0<e&&J(e)}},J=function(t){var e=$("#edit-"+t),n=$("#post-"+t).find(".column-mstaxsync_synced li"),i=e.find(".mstaxsync-broadcast-checklist li"),s=[];n.length&&i.length&&(n.each(function(){s.push($(this).attr("id"))}),i.each(function(){var t=$(this).attr("id"),e=!1,n=!1;-1<$.inArray(t,s)&&(n=e=!0),$(this).find("input").prop({checked:e,disabled:n})}))},K=function(){$("body").on("click",'input[name="bulk_edit"]',function(){$(this).after('<span class="spinner is-active"></span>');var t=$("#mstaxsync_quick_edit_post_broadcast").val(),e=$("tr#bulk-edit"),n=[],i=e.find(".mstaxsync-broadcast-checklist li"),s=[];e.find("#bulk-titles").children().each(function(){n.push($(this).attr("id").replace(/^(ttle)/i,""))}),n.length&&(i.each(function(){checked=$(this).find("input").attr("checked"),checked&&(id=$(this).attr("id").replace(/^(site-)/i,""),s.push(id))}),$.ajax({type:"post",url:_mstaxsync.ajaxurl,async:!1,cache:!1,data:{action:"bulk_broadcast",nonce:t,post_ids:n,dest_sites:s}}))})};return t}();mstaxsync.init();