/*! ms-tax-sync 2020-01-19 */

var $=jQuery,mstaxsync=function(){function r(t){return $("."+t+"-list")}var t={},d={relationship_fields:$(".mstaxsync-relationship"),single_post_meta_box:$("#mstaxsync_single_post_broadcast"),rtl:$("html").attr("dir")&&"rtl"==$("html").attr("dir"),totalImported:{}},i=function(t){var n=_mstaxsync.settings.edit_terms,e=[];return t.children&&t.children.length&&($.each(t.children,function(t,n){e.push(i({id:n.id,text:n.text,children:n.children}))}),e=e.join("")),['<li class="new">',"<div>",'<span class="mstaxsync-rel-item" data-id="'+t.id+'">','<span class="val">'+t.text+"</span>",n?'<input type="text" placeholder="'+t.text+'" />':"",'<span class="ind">('+_mstaxsync.strings.relationship_new_item_str+")</span>",n?'<span class="edit dashicons dashicons-edit"></span><span class="ok dashicons dashicons-yes"></span><span class="cancel dashicons dashicons-no"></span>':"",'<span class="remove dashicons dashicons-minus"></span>',"</span>","</div>",e.length?"<ul>"+e+"</ul>":"","</li>"].join("")};t.init=function(){n(),S(),L()};var n=function(){d.relationship_fields.length&&(_mstaxsync.settings.advanced_treeview.length?e():s(),c(),$('#mstaxsync-taxonomies input[name="submit"]').click(function(t){t.preventDefault(),E($(this))}),Q())},e=function(){a(),$("body").on("click",".choices-list li .mstaxsync-rel-item",function(){l($(this))}),$("body").on("click",'.choices-list li .mstaxsync-rel-item input[type="checkbox"]',function(t){t.stopPropagation(),m($(this).closest(d.relationship_fields))}),$("body").on("click",".choices-list li .mstaxsync-rel-item .check-all",function(t){t.stopPropagation(),o($(this))}),$("body").on("click",".choices-list li .mstaxsync-rel-item .uncheck-all",function(t){t.stopPropagation(),h($(this))}),$("body").on("click",".advanced-treeview-controls .check-all",function(t){p($(this))}),$("body").on("click",".advanced-treeview-controls .uncheck-all",function(t){u($(this))}),$("body").on("click",".advanced-treeview-controls .add-items",function(){f($(this))})},s=function(){$("body").on("click",".choices-list li .mstaxsync-rel-item",function(){b($(this))})},c=function(){$("body").on("click",".values-list li .remove",function(){k($(this).parent(".mstaxsync-rel-item"))}),$("body").on("click",".values-list li .edit",function(){C($(this))}),$("body").on("click",".values-list li .ok",function(){j($(this))}),$("body").on("keypress",".values-list li input",function(t){w(t)}),$("body").on("click",".values-list li .cancel",function(){T($(this))}),$("body").on("click",".values-list li .synced",function(){P($(this))}),$("body").on("click",".values-list li .trash",function(){I($(this))})},a=function(){var t=$('.mstaxsync-rel-item.disabled input[type="checkbox"]');t.length&&t.prop({checked:!0,disabled:!0})},l=function(t){var n=t.closest(d.relationship_fields),e=t.children('input[type="checkbox"]');if(t.hasClass("disabled"))return!1;e.prop("checked",!e.prop("checked")),m(n)},o=function(t){var n=t.closest(d.relationship_fields);t.closest("li").find('input[type="checkbox"]').prop("checked",!0),m(n)},h=function(t){var n=t.closest(d.relationship_fields);t.closest("li").find('input[type="checkbox"]').each(function(){var t=$(this);t.parent(".mstaxsync-rel-item").hasClass("disabled")||t.prop("checked",!1)}),m(n)},p=function(t){var n=t.closest(".mstaxsync-taxonomy-terms-box").children(d.relationship_fields),e=n.find(r("choices")).find('input[type="checkbox"]');e.length&&e.prop("checked",!0),m(n)},u=function(t){var n=t.closest(".mstaxsync-taxonomy-terms-box").children(d.relationship_fields),e=n.find(r("choices")).find('input[type="checkbox"]');e.length&&(e.each(function(){var t=$(this);t.parent(".mstaxsync-rel-item").hasClass("disabled")||t.prop("checked",!1)}),m(n))},m=function(t){var n=t.find(r("choices")).find('input[type="checkbox"]'),e=t.next(".advanced-treeview-controls").children(".add-items"),s=!1;n.length&&n.each(function(){var t=$(this);if(!t.parent(".mstaxsync-rel-item").hasClass("disabled")&&t.prop("checked"))return!(s=!0)}),s?e.addClass("enabled"):e.removeClass("enabled")},f=function(t){if(t.hasClass("enabled")){var n=t.closest(".mstaxsync-taxonomy-terms-box").children(d.relationship_fields),e=n.find(r("choices")).children("li"),s=[],i=[];e.length&&e.each(function(){y(s,i,$(this),0)}),_(n,i)}},y=function(t,n,e,s){var i=e.find(".mstaxsync-rel-item").first(),c=i.data("id"),a=i.children('input[type="checkbox"]'),l=i.children(".val").text(),o=e.children("ul").children("li"),r=x(t,s),d=!i.hasClass("disabled")&&a.prop("checked");t.push({id:c,parent:s,valid:d}),d&&n.push({id:c,text:l,parent:r}),o.length&&(s=c,o.each(function(){y(t,n,$(this),s)}))},x=function(t,n){if(0==n)return 0;var e=$.grep(t,function(t){return t.id==n});if(e.length){var s=e[0].parent;return e[0].valid?n:x(t,s)}return 0},_=function(t,n){var c=t.find(r("choices")),e=t.next(".advanced-treeview-controls").children(".add-items"),a=[];e.removeClass("enabled"),n.length&&($.each(n,function(t,n){var e=n.id,s=c.find("li .mstaxsync-rel-item[data-id="+e+"]"),i=s.children('input[type="checkbox"]');s.addClass("disabled"),i.prop({disabled:!0}),v(a,n)}),g(t,a))},v=function(t,e){var s=e.id,i=e.text,c=e.parent;0==c?t.push({id:s,text:i,children:[]}):$.each(t,function(t,n){if(c==n.id)return n.children.push({id:s,text:i,children:[]}),!1;n.children&&n.children.length&&v(n.children,e)})},g=function(s,t){t.length&&$.each(t,function(t,n){var e=i({id:n.id,text:n.text,children:n.children});s.find(r("values")).append(e)})},b=function(t){var n=t.closest(d.relationship_fields);if(t.hasClass("disabled"))return!1;t.addClass("disabled");var e=i({id:t.data("id"),text:t.children(".val").text()});n.find(r("values")).append(e)},k=function(t){var n=t.closest(d.relationship_fields),e=t.data("id"),s=t.closest("li"),i=s.children("ul"),c=s.siblings(),a=n.find(r("choices")).find("li .mstaxsync-rel-item[data-id="+e+"]"),l=_mstaxsync.settings.advanced_treeview;c.length||s.parent("ul").hasClass("list")||i.length||s.unwrap("ul"),i.length?(s.children("div").remove(),i.children("li").unwrap("ul").unwrap("li")):s.remove(),a.removeClass("disabled"),l.length&&a.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})},C=function(t){var n=t.closest(".mstaxsync-rel-item"),e=n.children("input");n.addClass("editing"),e.focus()},j=function(t){var n=t.closest(".mstaxsync-rel-item"),e=n.children(".val"),s=n.children("input");s.val().length&&(e.text(s.val()),s.attr("placeholder",e.text()),s.val(""),O(n.closest("li"))),n.removeClass("editing")},w=function(t){"13"==(t.keyCode?t.keyCode:t.which)&&j($(t.target)),t.stopPropagation()},T=function(t){var n=t.closest(".mstaxsync-rel-item");n.children("input").val(""),n.removeClass("editing")},P=function(s){var t=s.closest(d.relationship_fields),n=s.data("nonce"),e=s.closest(".mstaxsync-rel-item"),i=e.data("id"),c=e.data("synced"),a=t.find(r("choices")).find("li .mstaxsync-rel-item[data-id="+c+"]"),l=_mstaxsync.settings.advanced_treeview;_mstaxsync.settings.detach_terms&&confirm(_mstaxsync.strings.confirm_detach)&&(s.addClass("rotate"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"detach_taxonomy_term",nonce:n,main_id:c,local_id:i},success:function(t){s.remove(),e.data("synced",""),a.removeClass("disabled"),a.data("synced",""),l.length&&a.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})},error:function(t,n,e){s.removeClass("rotate")}}))},I=function(t){var n=t.closest(d.relationship_fields),e=t.data("nonce"),s=t.closest(".mstaxsync-rel-item"),i=n.data("name"),c=s.data("id"),a=s.data("synced"),l=_mstaxsync.settings.advanced_treeview,o=_mstaxsync.settings.delete_terms;s.children(".synced");o&&confirm(_mstaxsync.strings.confirm_delete)&&(s.addClass("removing"),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"delete_taxonomy_term",nonce:e,taxonomy:i,main_id:a,local_id:c},success:function(t){a&&(choice=n.find(r("choices")).find("li .mstaxsync-rel-item[data-id="+a+"]"),choice.removeClass("disabled"),choice.data("synced",""),l.length&&choice.children('input[type="checkbox"]').prop({checked:!1,disabled:!1})),s.css("opacity","0"),setTimeout(function(){k(s)},500)},error:function(t,n,e){s.removeClass("removing")}}))},E=function(t){var n=t.data("nonce"),e=A(),s=$(".submit .ajax-loading"),i=$(".submit").next(".result"),c=[];s.css("visibility","visible"),i.html("").hide(),$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"taxonomy_terms_sync",nonce:n,taxonomy_terms:e},success:function(t){B(t),D(t,c)},error:function(t,n,e){c.push(_mstaxsync.strings.relationship_internal_server_error_str)},complete:function(t,n){s.css("visibility","hidden"),i.show().html(c.join("<br />"))}})},A=function(){return taxonomyTerms=[],$.each(d.relationship_fields,function(){var t=$(this).find(r("values")).children("li"),n=[];t.length&&(t.each(function(){q(n,$(this),0)}),taxonomyTerms.push({taxonomy:$(this).data("name"),terms:n}))}),taxonomyTerms},q=function(t,n,e){var s=n.find(".mstaxsync-rel-item").first(),i=s.data("id"),c=s.children(".val").text(),a=n.hasClass("new")?"main":"local",l=n.children("ul").children("li");t.push({id:i,name:c,source:a,parent:e}),l.length&&(e=i,l.each(function(){q(t,$(this),e)}))},B=function(t){var c=_mstaxsync.settings.advanced_treeview;Object.keys(t.rs_fields).length&&$.each(t.rs_fields,function(t,n){var e=$('.mstaxsync-relationship[data-name="'+t+'"]'),s=n.choices,i=n.values;s.length&&(e.find(r("choices")).html(s),c.length&&a()),i.length&&e.find(r("values")).html(i)})},D=function(t,e){t.errors.length||e.push(_mstaxsync.strings.relationship_success_str),t.main.length&&e.push(t.main.length+" "+_mstaxsync.strings.relationship_main_terms_str),t.local.length&&e.push(t.local.length+" "+_mstaxsync.strings.relationship_local_terms_str),t.errors.length&&(e.push(_mstaxsync.strings.relationship_errors_str),$.each(t.errors,function(t,n){e.push(_mstaxsync.strings.relationship_error_str+" #"+n.code+": "+n.description)}))},O=function(t){var n=t.find(".mstaxsync-rel-item").first(),e=n.children(".val"),s=n.children(".ind"),i=n.children(".edit");t.addClass("changed"),s.length||(s=$('<span class="ind">('+_mstaxsync.strings.relationship_changed_item_str+")</span>"),i.length?s.insertBefore(i):s.insertAfter(e))},Q=function(){r("values").nestedSortable({listType:"ul",items:"li",handle:"div",toleranceElement:"> div",opacity:.6,revert:250,rtl:d.rtl,relocate:function(t,n){O(n.item)}})},S=function(){z(),H(),K()},z=function(){d.single_post_meta_box.length&&(d.single_post_meta_box.find(".check-all").click(function(){F($(this))}),d.single_post_meta_box.find(".uncheck-all").click(function(){G($(this))}))},F=function(t){t.closest(d.single_post_meta_box).find(".synced-sites input.unsynced-post").prop("checked",!0)},G=function(t){t.closest(d.single_post_meta_box).find(".synced-sites input.unsynced-post").prop("checked",!1)},H=function(){if("undefined"!=typeof inlineEditPost){var e=inlineEditPost.edit;inlineEditPost.edit=function(t){e.apply(this,arguments);var n=0;"object"==typeof t&&(n=parseInt(this.getId(t))),0<n&&J(n)}}},J=function(t){var n=$("#edit-"+t),e=$("#post-"+t).find(".column-mstaxsync_synced li"),s=n.find(".mstaxsync-broadcast-checklist li"),i=[];e.length&&s.length&&(e.each(function(){i.push($(this).attr("id"))}),s.each(function(){var t=$(this).attr("id"),n=!1,e=!1;-1<$.inArray(t,i)&&(e=n=!0),$(this).find("input").prop({checked:n,disabled:e})}))},K=function(){$("body").on("click",'input[name="bulk_edit"]',function(){$(this).after('<span class="spinner is-active"></span>');var t=$("#mstaxsync_quick_edit_post_broadcast").val(),n=$("tr#bulk-edit"),e=[],s=n.find(".mstaxsync-broadcast-checklist li"),i=[];n.find("#bulk-titles").children().each(function(){e.push($(this).attr("id").replace(/^(ttle)/i,""))}),e.length&&(s.each(function(){checked=$(this).find("input").attr("checked"),checked&&(id=$(this).attr("id").replace(/^(site-)/i,""),i.push(id))}),$.ajax({type:"post",url:_mstaxsync.ajaxurl,async:!1,cache:!1,data:{action:"bulk_broadcast",nonce:t,post_ids:e,dest_sites:i}}))})},L=function(){$("body").on("click",".mstaxsync-import",function(){M($(this))})},M=function(t){var n=t.parent(),e=t.data("nonce"),s=t.data("id"),i=t.data("term-count"),c=_mstaxsync.settings.import_posts,a=1<i?_mstaxsync.strings.confirm_import.replace("%s",i):_mstaxsync.strings.confirm_single_import;!n.hasClass("done")&&!n.hasClass("active")&&c&&confirm(a)&&(n.addClass("active"),d.totalImported[s]=0,N(n,s,e))},N=function(s,n,e){s&&n&&e&&$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"prepare_taxonomy_term_posts_import",nonce:e,main_term_id:n},success:function(t){s.children(".mstaxsync-import-result").html(_mstaxsync.strings.success_import+0),t.posts&&t.posts.length?R(s,n,t.posts,e):(s.addClass("done"),s.removeClass("active"))},error:function(t,n,e){s.children(".mstaxsync-import-result").html(_mstaxsync.strings.failed_import),s.removeClass("active")}})},R=function(e,s,i,c){i&&i.length&&$.each(i,function(t,n){U(e,s,n,t,i.length,c)})},U=function(e,n,t,s,i,c){t&&$.ajax({type:"post",dataType:"json",url:_mstaxsync.ajaxurl,data:{action:"import_post",nonce:c,post:t},success:function(t){t.length&&(d.totalImported[n]++,e.children(".mstaxsync-import-result").html(_mstaxsync.strings.success_import+d.totalImported[n]))},complete:function(t,n){s+1==i&&(e.addClass("done"),e.removeClass("active"))}})};return t}();mstaxsync.init();